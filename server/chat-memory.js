/**
 * –°–∏—Å—Ç–µ–º–∞ –ø–∞–º—è—Ç–∏ –¥–ª—è AI —á–∞—Ç–∞
 * –ó–∞–ø–æ–º–∏–Ω–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ AI
 */

const chatHistory = require('./chat-history');

// –°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è—Ö AI
const AI_CAPABILITIES = `
–¢–í–û–ò –í–û–ó–ú–û–ñ–ù–û–°–¢–ò –ò –§–£–ù–ö–¶–ò–ò:

üé® –ì–ï–ù–ï–†–ê–¶–ò–Ø –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ô:
- –°–æ–∑–¥–∞–≤–∞–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ –ª—é–±–æ–º—É –æ–ø–∏—Å–∞–Ω–∏—é
- –ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–º–∞–Ω–¥—ã: "–Ω–∞—Ä–∏—Å—É–π", "—Å–æ–∑–¥–∞–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ", "—Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π"
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é —Ä–∞–∑–Ω—ã–µ —Å—Ç–∏–ª–∏: —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π, —Ö—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π, –≤–µ–∫—Ç–æ—Ä–Ω—ã–π

üßµ –°–û–ó–î–ê–ù–ò–ï –í–´–®–ò–í–ö–ò:
- –°–æ–∑–¥–∞—é –¥–∏–∑–∞–π–Ω—ã –¥–ª—è –≤—ã—à–∏–≤–∞–ª—å–Ω—ã—Ö –º–∞—à–∏–Ω
- –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É—é –≤ —Ñ–æ—Ä–º–∞—Ç—ã: DST, PES, JEF, EXP, VP3
- –û–ø—Ç–∏–º–∏–∑–∏—Ä—É—é –¥–ª—è –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–π –≤—ã—à–∏–≤–∫–∏

üìÑ –°–û–ó–î–ê–ù–ò–ï SVG –î–õ–Ø –ü–ï–ß–ê–¢–ò:
- –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ SVG –¥–ª—è —à–µ–ª–∫–æ–≥—Ä–∞—Ñ–∏–∏ –∏ DTF –ø–µ—á–∞—Ç–∏
- –û–ø—Ç–∏–º–∏–∑–∏—Ä—É—é —Ñ–∞–π–ª—ã –¥–ª—è —Ç–µ–∫—Å—Ç–∏–ª—å–Ω–æ–≥–æ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞
- –°–æ–∑–¥–∞—é —Ü–≤–µ—Ç–æ–≤—ã–µ —Å—Ö–µ–º—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –ø–µ—á–∞—Ç–∏

üîç –í–ï–ë-–ü–û–ò–°–ö:
- –ò—â—É –∞–∫—Ç—É–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ
- –ü—Ä–æ–≤–µ—Ä—è—é –Ω–æ–≤–æ—Å—Ç–∏, –ø–æ–≥–æ–¥—É, –∫—É—Ä—Å—ã –≤–∞–ª—é—Ç
- –ù–∞—Ö–æ–∂—É –∞–¥—Ä–µ—Å–∞ –º–∞–≥–∞–∑–∏–Ω–æ–≤ –∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã

üì∑ –ê–ù–ê–õ–ò–ó –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ô:
- –û–ø–∏—Å—ã–≤–∞—é —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –∫–∞—Ä—Ç–∏–Ω–æ–∫
- –†–∞—Å–ø–æ–∑–Ω–∞—é –æ–±—ä–µ–∫—Ç—ã –∏ —Ç–µ–∫—Å—Ç
- –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —Ü–≤–µ—Ç–∞ –∏ –∫–æ–º–ø–æ–∑–∏—Ü–∏—é

üíª –ü–†–û–ì–†–ê–ú–ú–ò–†–û–í–ê–ù–ò–ï:
- –ü–∏—à—É –∫–æ–¥ –Ω–∞ —Ä–∞–∑–Ω—ã—Ö —è–∑—ã–∫–∞—Ö
- –ü–æ–º–æ–≥–∞—é —Å –æ—Ç–ª–∞–¥–∫–æ–π –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π
- –û–±—ä—è—Å–Ω—è—é —Å–ª–æ–∂–Ω—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏

–í–ê–ñ–ù–û: –Ø –≤—Å–µ–≥–¥–∞ –ø–æ–º–Ω—é —Å–≤–æ–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∏ –ø—Ä–µ–¥–ª–∞–≥–∞—é –∏—Ö –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–≥–¥–∞ —ç—Ç–æ —É–º–µ—Å—Ç–Ω–æ!
`;

/**
 * –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Å–µ—Å—Å–∏–∏ –¥–ª—è AI
 */
async function getSessionContext(sessionId, maxMessages = 10) {
  try {
    const messages = await chatHistory.getSessionMessages(sessionId);
    
    if (!messages || messages.length === 0) {
      return {
        context: AI_CAPABILITIES,
        messageCount: 0
      };
    }

    // –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    const recentMessages = messages.slice(-maxMessages);
    
    // –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
    let conversationHistory = '\n–ò–°–¢–û–†–ò–Ø –†–ê–ó–ì–û–í–û–†–ê:\n';
    recentMessages.forEach(msg => {
      const sender = msg.sender === 'user' ? '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å' : '–¢—ã (AI)';
      conversationHistory += `${sender}: ${msg.content}\n`;
    });

    // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º, –±—ã–ª–∏ –ª–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    const hasGeneratedImages = recentMessages.some(msg => 
      msg.content && msg.content.includes('![–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ]')
    );

    let contextNotes = '';
    if (hasGeneratedImages) {
      contextNotes += '\nüìù –ö–û–ù–¢–ï–ö–°–¢: –í —ç—Ç–æ–º —Ä–∞–∑–≥–æ–≤–æ—Ä–µ —Ç—ã —É–∂–µ —Å–æ–∑–¥–∞–≤–∞–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–Ω–∞–µ—Ç –æ —Ç–≤–æ–∏—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è—Ö –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.\n';
    }

    return {
      context: AI_CAPABILITIES + conversationHistory + contextNotes,
      messageCount: recentMessages.length,
      hasImages: hasGeneratedImages
    };

  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Å–µ—Å—Å–∏–∏:', error);
    return {
      context: AI_CAPABILITIES,
      messageCount: 0
    };
  }
}

/**
 * –°–æ–∑–¥–∞–Ω–∏–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ —Å –ø–∞–º—è—Ç—å—é
 */
function createEnhancedPrompt(userQuery, sessionContext) {
  return `${sessionContext.context}

–ù–û–í–´–ô –ó–ê–ü–†–û–° –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø: "${userQuery}"

–ò–ù–°–¢–†–£–ö–¶–ò–ò:
1. –ü–æ–º–Ω–∏ –æ —Å–≤–æ–∏—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è—Ö: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π, –≤–µ–±-–ø–æ–∏—Å–∫, —Å–æ–∑–¥–∞–Ω–∏–µ –≤—ã—à–∏–≤–∫–∏, –∞–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
2. –ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
3. –ü—Ä–µ–¥–ª–∞–≥–∞–π —Å–≤–æ–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –∫–æ–≥–¥–∞ —ç—Ç–æ —É–º–µ—Å—Ç–Ω–æ
4. –û—Ç–≤–µ—á–∞–π –ø–æ–ª–µ–∑–Ω–æ –∏ –ø–æ —Å—É—â–µ—Å—Ç–≤—É
5. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç —Å–æ–∑–¥–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ - –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–π —Ñ—É–Ω–∫—Ü–∏—é –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏

–û—Ç–≤–µ—Ç:`;
}

/**
 * –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –∑–∞–ø—Ä–æ—Å–∞ —Å —É—á–µ—Ç–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
 */
function analyzeRequestWithContext(userQuery, sessionContext) {
  const lowerQuery = userQuery.toLowerCase();
  
  // –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∑–∞–ø—Ä–æ—Å–æ–≤
  const imageKeywords = ['–Ω–∞—Ä–∏—Å—É–π', '—Å–æ–∑–¥–∞–π', '—Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π', '–ø—Ä–∏–Ω—Ç', '–¥–∏–∑–∞–π–Ω', '–∫–∞—Ä—Ç–∏–Ω–∫–∞', '–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ', '–ª–æ–≥–æ—Ç–∏–ø', '–±–∞–Ω–Ω–µ—Ä'];
  const searchKeywords = ['–Ω–∞–π–¥–∏', '–ø–æ–∏—â–∏', '–≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è', '–∞–¥—Ä–µ—Å', '—Ç–µ–ª–µ—Ñ–æ–Ω', '–≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã', '–ø–æ–≥–æ–¥–∞', '–Ω–æ–≤–æ—Å—Ç–∏', '–∫—É—Ä—Å'];
  const embroideryKeywords = ['–≤—ã—à–∏–≤–∫', 'dst', 'pes', 'jef', '–≤—ã—à–∏–≤–∞–ª—å–Ω'];
  
  return {
    isImageRequest: imageKeywords.some(keyword => lowerQuery.includes(keyword)),
    isSearchRequest: searchKeywords.some(keyword => lowerQuery.includes(keyword)),
    isEmbroideryRequest: embroideryKeywords.some(keyword => lowerQuery.includes(keyword)),
    needsContext: sessionContext.messageCount > 0
  };
}

/**
 * –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏
 */
async function saveOperationInfo(sessionId, operation, details) {
  try {
    const operationRecord = {
      sessionId,
      operation,
      details,
      timestamp: new Date().toISOString()
    };
    
    // –ú–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
    console.log('üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ–ø–µ—Ä–∞—Ü–∏–∏:', operationRecord);
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –æ–ø–µ—Ä–∞—Ü–∏–∏:', error);
  }
}

module.exports = {
  getSessionContext,
  createEnhancedPrompt,
  analyzeRequestWithContext,
  saveOperationInfo,
  AI_CAPABILITIES
};