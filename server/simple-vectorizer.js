/**
 * Ğ£Ğ¿Ñ€Ğ¾Ñ‰ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ²ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ‚Ğ¾Ñ€ Ğ´Ğ»Ñ BOOOMERANGS AI
 * Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ ImageTracerJS Ğ±ĞµĞ· canvas Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹
 */

import express from 'express';
import cors from 'cors';
import multer from 'multer';
import path from 'path';
import fs from 'fs';
import { fileURLToPath } from 'url';
import ImageTracer from 'imagetracerjs';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const app = express();
const PORT = process.env.VECTORIZER_PORT || 5006;

// Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ½ÑƒÑ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ
const outputDir = path.join(process.cwd(), 'output');
if (!fs.existsSync(outputDir)) {
  fs.mkdirSync(outputDir, { recursive: true });
}

// Middleware
app.use(cors());
app.use(express.json());
app.use('/output', express.static(outputDir));

// ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° multer
const storage = multer.memoryStorage();
const upload = multer({ 
  storage: storage,
  limits: { fileSize: 10 * 1024 * 1024 }
});

// Health check
app.get('/health', (req, res) => {
  res.json({
    status: 'ok',
    service: 'Simple ImageTracerJS Vectorizer',
    port: PORT.toString(),
    uptime: process.uptime(),
    timestamp: new Date().toISOString()
  });
});

// ĞĞ¿Ñ†Ğ¸Ğ¸ Ğ²ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸
app.get('/options', (req, res) => {
  res.json({
    availableOptions: {
      ltres: 'ĞŸĞ¾Ñ€Ğ¾Ğ³ ÑÑ€ĞºĞ¾ÑÑ‚Ğ¸ (0-255, Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ: 1)',
      qtres: 'ĞŸĞ¾Ñ€Ğ¾Ğ³ ĞºĞ²Ğ°Ğ½Ñ‚Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ (0-255, Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ: 1)', 
      pathomit: 'ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ´Ğ»Ğ¸Ğ½Ğ° Ğ¿ÑƒÑ‚Ğ¸ (Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ: 8)',
      colorsampling: 'Ğ¡ÑĞ¼Ğ¿Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ†Ğ²ĞµÑ‚Ğ¾Ğ² (0-2, Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ: 1)',
      numberofcolors: 'ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ñ†Ğ²ĞµÑ‚Ğ¾Ğ² (2-256, Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ: 16)',
      mincolorratio: 'ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ÑĞ¾Ğ¾Ñ‚Ğ½Ğ¾ÑˆĞµĞ½Ğ¸Ğµ Ñ†Ğ²ĞµÑ‚Ğ¾Ğ² (Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ: 0.02)',
      colorquantcycles: 'Ğ¦Ğ¸ĞºĞ»Ñ‹ ĞºĞ²Ğ°Ğ½Ñ‚Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ñ†Ğ²ĞµÑ‚Ğ¾Ğ² (Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ: 3)',
      scale: 'ĞœĞ°ÑÑˆÑ‚Ğ°Ğ± (Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ: 1)',
      roundcoords: 'ĞĞºÑ€ÑƒĞ³Ğ»ĞµĞ½Ğ¸Ğµ ĞºĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ‚ (Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ: 1)'
    },
    presets: {
      default: 'Ğ¡Ñ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ñ‹Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸',
      simple: 'Ğ£Ğ¿Ñ€Ğ¾Ñ‰ĞµĞ½Ğ½Ñ‹Ğ¹ (Ğ¼Ğ°Ğ»Ğ¾ Ñ†Ğ²ĞµÑ‚Ğ¾Ğ²)',
      detailed: 'Ğ”ĞµÑ‚Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚'
    }
  });
});

// Ğ’ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ñ„Ğ°Ğ¹Ğ»Ğ°
app.post('/vectorize', upload.single('image'), async (req, res) => {
  try {
    if (!req.file) {
      return res.status(400).json({
        success: false,
        error: 'Ğ¤Ğ°Ğ¹Ğ» Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ Ğ½Ğµ Ğ¿Ñ€ĞµĞ´Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½'
      });
    }

    const imageBuffer = req.file.buffer;
    const timestamp = Date.now();
    const filename = `vectorized_${timestamp}`;

    // Ğ‘Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ ImageTracer
    const options = {
      ltres: 1,
      qtres: 1,
      pathomit: 8,
      colorsampling: 1,
      numberofcolors: 12,
      mincolorratio: 0.02,
      colorquantcycles: 3,
      scale: 1,
      roundcoords: 1
    };

    // ĞŸÑ€ĞµĞ¾Ğ±Ñ€Ğ°Ğ·ÑƒĞµĞ¼ Buffer Ğ² base64 data URL
    const mimeType = req.file.mimetype;
    const base64Image = `data:${mimeType};base64,${imageBuffer.toString('base64')}`;
    
    console.log('ğŸ¨ Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾Ğ¹ Ğ²ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸...');
    
    // Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµĞ¼ Ğ²ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ
    const svgString = await new Promise((resolve, reject) => {
      try {
        // Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾Ğ¹ callback Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´
        ImageTracer.imageToSVG(base64Image, (svgResult) => {
          if (svgResult && typeof svgResult === 'string') {
            resolve(svgResult);
          } else {
            reject(new Error('ĞĞµĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹Ğ¹ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ğ²ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸'));
          }
        }, options);
      } catch (error) {
        reject(error);
      }
    });

    // Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚
    const svgPath = path.join(outputDir, `${filename}.svg`);
    fs.writeFileSync(svgPath, svgString);
    
    console.log(`âœ… Ğ’ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°: ${filename}.svg`);

    res.json({
      success: true,
      message: 'Ğ’ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ° ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾',
      data: {
        svgContent: svgString,
        filename: `${filename}.svg`,
        url: `/output/${filename}.svg`,
        metadata: {
          timestamp,
          originalSize: imageBuffer.length,
          svgSize: svgString.length,
          vectorizer: 'ImageTracerJS-Simple'
        }
      }
    });

  } catch (error) {
    console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ²ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸:', error);
    res.status(500).json({
      success: false,
      error: 'ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ²ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ',
      details: error.message
    });
  }
});

// Ğ’ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾ URL
app.post('/vectorize-url', async (req, res) => {
  try {
    const { imageUrl, options: customOptions } = req.body;
    
    if (!imageUrl) {
      return res.status(400).json({ 
        error: 'URL Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ Ğ½Ğµ Ğ¿Ñ€ĞµĞ´Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½',
        success: false 
      });
    }

    console.log(`ğŸŒ Ğ’ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾ URL: ${imageUrl}`);
    
    const timestamp = Date.now();
    const filename = `vectorized_url_${timestamp}`;
    
    // ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ²ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸
    const options = {
      ltres: 1,
      qtres: 1,
      pathomit: 8,
      colorsampling: 1,
      numberofcolors: 12,
      mincolorratio: 0.02,
      colorquantcycles: 3,
      scale: 1,
      roundcoords: 1,
      ...customOptions
    };

    console.log('ğŸ¨ Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ²ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ğ¾ URL...');
    
    // Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµĞ¼ Ğ²ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ½Ğ°Ğ¿Ñ€ÑĞ¼ÑƒÑ Ğ¿Ğ¾ URL
    const svgString = await new Promise((resolve, reject) => {
      try {
        ImageTracer.imageToSVG(imageUrl, (svgResult) => {
          if (svgResult && typeof svgResult === 'string') {
            resolve(svgResult);
          } else {
            reject(new Error('ĞĞµĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹Ğ¹ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ğ²ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸'));
          }
        }, options);
      } catch (error) {
        reject(error);
      }
    });

    // Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚
    const svgPath = path.join(outputDir, `${filename}.svg`);
    fs.writeFileSync(svgPath, svgString);
    
    const metadata = {
      filename: `${filename}.svg`,
      timestamp: timestamp,
      sourceUrl: imageUrl,
      svgSize: svgString.length,
      options: options,
      vectorizer: 'ImageTracerJS-Simple'
    };

    console.log(`âœ… Ğ’ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾ URL Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°: ${filename}.svg`);

    res.json({
      success: true,
      message: 'Ğ’ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾ URL Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ° ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾',
      data: {
        svgContent: svgString,
        filename: `${filename}.svg`,
        url: `/output/${filename}.svg`,
        metadata: metadata
      }
    });

  } catch (error) {
    console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ²ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ğ¾ URL:', error);
    res.status(500).json({
      success: false,
      error: 'ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ²ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾ URL',
      details: error.message
    });
  }
});

// Ğ—Ğ°Ğ¿ÑƒÑĞº ÑĞµÑ€Ğ²ĞµÑ€Ğ°
app.listen(PORT, '0.0.0.0', () => {
  console.log(`ğŸš€ Simple ImageTracerJS Vectorizer Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½ Ğ½Ğ° Ğ¿Ğ¾Ñ€Ñ‚Ñƒ ${PORT}`);
  console.log(`ğŸ“ Ğ’Ñ‹Ñ…Ğ¾Ğ´Ğ½Ğ°Ñ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ: ${outputDir}`);
  console.log(`ğŸ”— Health check: http://localhost:${PORT}/health`);
  console.log(`ğŸ“‹ Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ğµ Ğ¾Ğ¿Ñ†Ğ¸Ğ¸: http://localhost:${PORT}/options`);
});

export default app;